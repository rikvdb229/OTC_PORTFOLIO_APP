<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>Portfolio tracker</title>
  <meta http-equiv="Content-Security-Policy" content="
      default-src 'self' 'unsafe-inline';
      script-src 'self' 'unsafe-inline' 'unsafe-eval';
      style-src 'self' 'unsafe-inline';
      img-src 'self' data: blob:;
      font-src 'self';
      connect-src 'self' https://api.github.com;
      object-src 'none';
      base-uri 'self';
    " />
  <meta http-equiv="X-Content-Type-Options" content="nosniff" />
  <meta http-equiv="X-XSS-Protection" content="1; mode=block" />

  <link rel="stylesheet" href="styles/main.css" />
</head>

<body>
  <!-- MAIN CONTENT WRAPPER -->
  <div class="main-content">
    <!-- MAIN HEADER - Always Sticky -->
    <div class="main-header">
      <header class="header">
        <div class="header-brand">
          <img src="assets/logo.svg" alt="Portfolio Tracker" class="header-logo" />
        </div>
        <div class="header-actions">
          <!-- Undo/Redo Buttons - NEW -->
          <div class="undo-redo-group">
            <button id="undoBtn" class="header-btn btn-undo" disabled title="Nothing to undo">
              ‚Ü∂ Undo
            </button>
            <button id="redoBtn" class="header-btn btn-redo" disabled title="Nothing to redo">
              ‚Ü∑ Redo
            </button>
          </div>

          <!-- Notification - Moved to left of undo/redo -->
          <div id="priceUpdateNotification" class="header-notification" style="display: none">
            <span class="notification-icon">‚ö†Ô∏è</span>
            <span class="notification-text">Prices not current</span>
          </div>

          <!-- Existing buttons -->
          <button id="updatePricesBtn" class="header-btn btn-update-prices">
            üìä Update Prices
          </button>
          <button id="settingsToggle" class="header-btn btn-settings">
            ‚öôÔ∏è Settings
          </button>
        </div>
      </header>

      <!-- NEW: Compact stats bar (ABOVE tabs) -->
      <div class="global-portfolio-stats-compact">
        <div class="portfolio-stats-horizontal">
          <div class="stat-item-horizontal">
            <span class="stat-label-compact">Portfolio:</span>
            <span id="totalPortfolioValue" class="stat-value-compact">‚Ç¨ ---</span>
            <span id="portfolioChange" class="stat-change-compact">---</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-item-horizontal">
            <span class="stat-label-compact">Sellable:</span>
            <span id="totalSellableValue" class="stat-value-compact">‚Ç¨ ---</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-item-horizontal">
            <span class="stat-label-compact">Return:</span>
            <span id="totalReturnPercentage" class="stat-value-compact">---%</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-item-horizontal">
            <span class="stat-label-compact">Options:</span>
            <span id="totalOptions" class="stat-value-compact">---</span>
          </div>
          <div class="stat-separator">|</div>
          <div class="stat-item-horizontal">
            <span class="stat-label-compact">Updated:</span>
            <span id="lastPriceUpdate" class="stat-value-compact">---</span>
          </div>
        </div>
      </div>
    </div>
    <!-- Navigation Tabs - SEAMLESS CONNECTION -->
    <nav class="nav-tabs">
      <button class="nav-tab active" data-tab="portfolio">Portfolio</button>
      <button class="nav-tab" data-tab="evolution">Evolution</button>
      <button class="nav-tab" data-tab="chart">Chart</button>
      <button class="nav-tab" data-tab="sales-history">Sales History</button>
      <button class="nav-tab" data-tab="grant-history">Grant History</button>
    </nav>

    <!-- Global Portfolio Stats - CONSISTENT SPACING -->
    <!-- TAB HEADERS - UPDATED STRUCTURE -->
    <div class="tab-header">
      <!-- Portfolio Tab Header - Action Buttons -->
      <div id="portfolio-tab-header" class="portfolio-tab-header tab-header-content active">
        <button id="addGrantsBtn" class="btn btn-primary">
          ‚ûï Add Grants
        </button>
      </div>

      <!-- Evolution Tab Header - Time Controls -->
      <div id="evolution-tab-header" class="controls-tab-header tab-header-content">
        <div class="evolution-period-stats">
          <span class="evolution-stat-label">Change since <span id="evolution-oldest-date">---</span>:</span>
          <span id="evolution-gain-loss" class="evolution-stat-value">---</span>
          <span id="evolution-change-percent" class="evolution-stat-value">---</span>
        </div>
        <div class="evolution-filter-buttons">
          <button class="btn btn-small btn-secondary" data-days="30">
            30 Days
          </button>
          <button class="btn btn-small btn-secondary" data-days="90">
            90 Days
          </button>
          <button class="btn btn-small btn-secondary" data-days="365">
            1 Year
          </button>
          <button class="btn btn-small btn-primary" data-days="all">
            All Time
          </button>
        </div>
      </div>

      <!-- Chart Tab Header - Period Controls -->
      <div id="chart-tab-header" class="controls-tab-header tab-header-content">
        <button class="btn btn-small btn-secondary" data-period="30">
          30 Days
        </button>
        <button class="btn btn-small btn-secondary" data-period="90">
          90 Days
        </button>
        <button class="btn btn-small btn-secondary" data-period="365">
          1 Year
        </button>
        <button class="btn btn-small btn-primary" data-period="all">
          All Time
        </button>
      </div>

      <!-- Sales History Tab Header - UPDATED WITH SUMMARY CARDS -->
      <div id="sales-history-tab-header" class="summary-tab-header tab-header-content">
        <div class="summary-cards">
          <div class="summary-card">
            <h4>Total Sold Value</h4>
            <div id="totalSoldValue" class="summary-value">‚Ç¨ 0.00</div>
          </div>
          <div class="summary-card">
            <h4>Options Sold</h4>
            <div id="totalOptionsSold" class="summary-value">1,061</div>
          </div>
          <div class="summary-card">
            <h4>Average Sale Price</h4>
            <div id="averageSalePrice" class="summary-value">‚Ç¨ 16.20</div>
          </div>
        </div>
      </div>

      <!-- Grant History Tab Header - UPDATED WITH SUMMARY CARDS -->
      <div id="grant-history-tab-header" class="summary-tab-header tab-header-content">
        <div class="summary-cards">
          <div class="summary-card">
            <h4>Total Grants</h4>
            <div id="totalGrants" class="summary-value">14</div>
          </div>
          <div class="summary-card">
            <h4>Total Options Granted</h4>
            <div id="totalOptionsGranted" class="summary-value">9,569</div>
          </div>
          <div class="summary-card">
            <h4>Still Active</h4>
            <div id="activeGrants" class="summary-value">10</div>
          </div>
        </div>

        <!-- Modern Toggle Filters -->
        <div class="grant-modern-filters">
          <div class="filter-toggle active" data-filter="active">
            <span class="filter-label">Active</span>
          </div>
          <div class="filter-toggle active" data-filter="partially-sold">
            <span class="filter-label">Partially Sold</span>
          </div>
          <div class="filter-toggle active" data-filter="sold">
            <span class="filter-label">Sold</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Portfolio Tab Content -->
    <div id="portfolio-tab" class="tab-content active">
      <div class="scrollable-content">
        <div class="table-container">
          <table id="portfolioTable" class="portfolio-table">
            <thead>
              <tr>
                <th colspan="5" class="group-header">Grant Information</th>
                <th colspan="5" class="group-header">
                  Current Status and Performance
                </th>
                <th colspan="2" class="group-header">Status and Actions</th>
              </tr>
              <tr>
                <th class="sortable" data-sort="grant_date" width="7%">
                  Grant Date
                </th>
                <th data-sort="fund_name" width="15%">Underlying</th>
                <th class="sortable" data-sort="quantity_remaining" width="7%">
                  Quantity
                </th>
                <th class="sortable" data-sort="amount_granted" width="9%">
                  Amount Granted
                </th>
                <th width="9%">Tax Amount</th>
                <th class="sortable" data-sort="current_value" width="7%">
                  Current Price
                </th>
                <th class="sortable" data-sort="current_total_value" width="8%">
                  Total Value
                </th>
                <th class="sortable" data-sort="profit_loss_vs_target" width="8%">
                  P&L vs Target
                </th>
                <th class="sortable" data-sort="current_return_percentage" width="7%">
                  Return %
                </th>
                <th class="sortable" data-sort="normalized_price_percentage" width="7%">
                  Normalized Price %
                </th>
                <th data-sort="selling_status" width="6%">Status</th>
                <th width="15%">Actions</th>
              </tr>
            </thead>
            <tbody id="portfolioTableBody">
              <!-- Portfolio data -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Evolution Tab Content -->
    <div id="evolution-tab" class="tab-content">
      <div class="scrollable-content">
        <div class="table-container">
          <table id="evolutionTable" class="evolution-table">
            <thead>
              <tr>
                <th colspan="2" class="group-header">Timeline Information</th>
                <th colspan="3" class="group-header">Portfolio Changes</th>
                <th colspan="1" class="group-header">Details & Notes</th>
              </tr>
              <tr>
                <!-- FIXED: Use snapshot_date (actual database column) -->
                <th class="sortable" data-sort="snapshot_date" width="10%">
                  Date
                </th>
                <!-- FIXED: Use total_portfolio_value (actual database column) -->
                <th width="10%">Total Value</th>
                <!-- These columns are calculated, not sortable from raw data -->
                <th width="10%">Change from Previous</th>
                <th width="10%">% Change</th>
                <th width="10%">Days Gap</th>
                <th width="50%">Notes</th>
              </tr>
            </thead>
            <tbody id="evolutionTableBody">
              <!-- Evolution data -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Chart Tab Content -->
    <div id="chart-tab" class="tab-content">
      <div class="scrollable-content">
        <div class="chart-container" id="portfolioOverviewChart">
          <canvas id="portfolioChart"></canvas>
        </div>
        <div class="chart-legend">
          <!-- Chart legend -->
        </div>
      </div>
    </div>

    <!-- Sales History Tab Content -->
    <div id="sales-history-tab" class="tab-content">
      <div class="scrollable-content">
        <div class="table-container">
          <table id="salesTable" class="sales-table">
            <thead>
              <tr>
                <th colspan="3" class="group-header">INFO</th>
                <th colspan="4" class="group-header">SALES OVERVIEW</th>
                <th colspan="2" class="group-header">ACTIONS & NOTES</th>
              </tr>
              <tr>
                <th class="sortable" data-sort="sale_date" width="7%">
                  Sale Date
                </th>
                <th class="sortable" data-sort="grant_date" width="7%">
                  Original Grant Date
                </th>
                <th width="20%">Underlying Fund</th>
                <th class="sortable" data-sort="quantity_sold" width="7%">
                  Quantity Sold
                </th>
                <th class="sortable" data-sort="sale_price" width="7%">
                  Sale Price
                </th>
                <th class="sortable" data-sort="total_sale_value" width="7%">
                  Total Sale Value
                </th>
                <th class="sortable" data-sort="realized_gain_loss" width="7%">
                  P&L vs target
                </th>
                <th width="30%">Notes</th>
                <th width="5%">Actions</th>
              </tr>
            </thead>
            <tbody id="salesTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Grant History Tab Content -->
    <div id="grant-history-tab" class="tab-content">
      <div class="scrollable-content">
        <div class="table-container">
          <table id="grantTable" class="grant-table">
            <thead>
              <tr>
                <th colspan="2" class="group-header">INFO</th>
                <th colspan="2" class="group-header">QUANTITIES</th>
                <th colspan="1" class="group-header">STATUS</th>
              </tr>
              <tr>
                <th class="sortable" data-sort="grant_date" width="20%">
                  Grant Date
                </th>
                <th data-sort="fund_name" width="30%">Underlying Fund</th>
                <th class="sortable" data-sort="quantity" width="20%">
                  Quantity Granted
                </th>
                <th class="sortable" data-sort="quantity_remaining" width="20%">
                  Quantity Remaining
                </th>
                <th data-sort="status" width="10%">Status</th>
              </tr>
            </thead>
            <tbody id="grantTableBody">
              <!-- Grant data -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Sidebar -->
  <div id="settingsSidebar" class="settings-sidebar">
    <div class="settings-header">
      <h3>Settings</h3>
    </div>
    <div class="settings-content">
      <div class="setting-item">
        <label for="targetPercentage">Target Percentage</label>
        <div class="input-group">
          <input type="number" id="targetPercentage" min="1" max="500" value="65" />
          <span class="input-suffix">%</span>
        </div>
        <small class="form-help">Target return percentage for color coding</small>
      </div>

      <div class="setting-item">
        <label for="taxRate">Auto Tax Rate</label>
        <div class="input-group">
          <input type="number" id="taxRate" min="0" max="100" value="30" />
          <span class="input-suffix">%</span>
        </div>
        <small class="form-help">Default tax rate for new options</small>
        <small class="tax-info">üí° Tax appears as code 3510 on your payslip</small>
      </div>

      <div class="setting-item">
        <label for="currencySymbol">Currency Symbol</label>
        <input type="text" id="currencySymbol" value="‚Ç¨" maxlength="3" />
      </div>

      <div class="setting-item">
        <label class="checkbox-label">
          <input type="checkbox" id="autoUpdatePrices" />
          <span class="checkmark"></span>
          Auto-update prices on startup
        </label>
        <small class="form-help">Automatically scrape latest prices when app starts</small>
      </div>
      <div class="setting-item">
        <label>Database Management</label>
        <div class="database-actions">
          <button id="importDatabaseBtn" class="btn btn-secondary btn-full">
            üì• Import Database
          </button>
          <button id="exportDatabaseBtn" class="btn btn-secondary btn-full">
            üì§ Export Database
          </button>
          <button id="deleteDatabaseBtn" class="btn btn-danger btn-full">
            üóëÔ∏è Delete Database
          </button>
        </div>
        <small class="form-help">
          Backup your data or transfer between computers
        </small>
      </div>

      <div class="setting-item">
        <label>Historical Price Data</label>
        <div class="database-actions">
          <button id="updateHistoricalPricesBtn" class="btn btn-primary btn-full">
            üìä Update Historical Prices
          </button>
        </div>
        <small class="form-help">
          Download historical price data for all options in your portfolio. This improves accuracy of evolution tracking
          but may take several minutes.
        </small>
      </div>

      <button id="saveSettingsBtn" class="btn btn-primary btn-full">
        üíæ Save Settings
      </button>

      <button id="closeSettings" class="btn btn-secondary btn-full" style="margin-top: 10px">
        ‚úï Close Settings
      </button>
    </div>
  </div>
  <!-- Settings Overlay -->
  <div id="settingsOverlay" class="settings-overlay"></div>

  <!-- Update Prices Modal -->
  <div id="updatePricesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Updating Prices</h3>
      </div>
      <div class="modal-body">
        <div class="progress-container">
          <div class="progress-bar">
            <div id="updateProgressBar" class="progress-fill"></div>
          </div>
          <div id="updateProgressText" class="progress-text">
            Connecting...
          </div>
        </div>
        <div class="update-status">
          <div id="updateStatusOutput" class="status-output">
            Starting price update process...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Add Grants Modal -->
  <div id="addGrantsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Grants</h3>
      </div>
      <div class="modal-body">

        <!-- Grant Source Selection -->
        <div class="form-group">
          <label for="grantSource">Grant Source</label>
          <select id="grantSource" class="form-control" onchange="portfolioApp.toggleIsinField()">
            <option value="" selected>-- Select Grant Source --</option>
            <option value="KBC">KBC</option>
            <option value="ING">ING</option>
          </select>
          <small class="form-help">Please select grant source (KBC or ING)</small>
        </div>

        <!-- Grant Form Fields (hidden until source is selected) -->
        <div id="grantFormFields" style="display: none;">
          <div class="form-group">
            <label for="grantDate">Grant Date</label>
            <input type="date" id="grantDate" required />
            <small class="form-help">Enter the grant date from your option plan</small>
          </div>

          <!-- ISIN Field (for ING grants) -->
          <div class="form-group" id="isinGroup" style="display: none;">
            <label for="isin">ISIN (FOP Number)</label>
            <input type="text" id="isin" class="form-control" pattern="[A-Z0-9]{12}" title="12-character ISIN format"
              placeholder="Enter 12-character ISIN" required />
            <small class="form-help">Required for ING grants</small>
          </div>

          <div class="form-group">
            <label for="exercisePrice">Available Options</label>
            <select id="exercisePrice" required disabled>
              <option value="">First enter grant date...</option>
            </select>
            <small class="form-help" id="exercisePriceHelp">
              Options will appear after entering grant date
            </small>
          </div>

          <div class="form-group">
            <label for="quantity">Quantity Granted</label>
            <input type="number" id="quantity" min="1" required />
            <small class="form-help">Number must be a whole number</small>
          </div>

          <div class="form-group" id="currentValueGroup" style="display: none;">
            <label for="currentValue">Current Grant Value</label>
            <div class="value-display">
              <div class="value-info">
                <span class="value-label">Value per option:</span>
                <span id="currentValuePerOption" class="value-amount">‚Ç¨0.00</span>
              </div>
              <div class="value-info">
                <span class="value-label">Total grant value:</span>
                <span id="totalGrantValue" class="value-amount highlight">‚Ç¨0.00</span>
              </div>
            </div>
            <small class="form-help" id="currentValueHelp">
              This value will be used for portfolio calculations
            </small>
          </div>

          <div class="tax-section">
            <div class="tax-info">
              <div class="tax-calculation">
                <strong>Estimated Tax (Auto):</strong>
                <span id="estimatedTax" class="tax-amount">‚Ç¨ 0.00</span>
              </div>
              <small class="tax-note">üí° This will appear as code 3510 on your payslip</small>
            </div>

            <div class="form-group">
              <label for="actualTaxAmount">Actual Tax Amount (Optional)</label>
              <div class="input-group">
                <span class="input-prefix">‚Ç¨</span>
                <input type="number" id="actualTaxAmount" step="0.01" min="0"
                  placeholder="Leave empty to use auto-calculated" />
              </div>
              <small class="form-help">
                Override auto-calculated tax if you know the exact amount
              </small>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="canceladdGrants" class="btn btn-secondary">Cancel</button>
        <button id="confirmaddGrants" class="btn btn-primary">
          Add Grants
        </button>
      </div>
    </div>
  </div>

  <!-- Merge Grants Modal -->
  <div id="mergeGrantsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="mergeModalTitle">üîÑ Merge Option Grants</h3>
      </div>
      <div class="modal-body">
        <div id="singleGrantMerge" class="merge-warning" style="display: none">
          <p><strong>Existing Grant Found!</strong></p>
          <div class="existing-grant-details">
            <p>
              <strong>Current Quantity:</strong>
              <span id="existingQuantity">-</span> options
            </p>
          </div>
          <div class="new-grant-details">
            <p>
              <strong>New Quantity:</strong>
              <span id="newQuantitySingle">-</span> options
            </p>
          </div>
        </div>

        <div id="multipleGrantsMerge" class="merge-warning" style="display: none">
          <p><strong>Multiple Existing Grants Found!</strong></p>
          <p>
            You have multiple grants with the same grant date and exercise
            price.
          </p>
          <div class="new-grant-details">
            <p>
              <strong>You are adding:</strong>
              <span id="newQuantityMultiple">-</span> options
            </p>
          </div>
          <p><strong>Select which grant to merge with:</strong></p>

          <div id="existingGrantsList" class="existing-grants-list">
            <!-- Populated dynamically -->
          </div>
        </div>

        <div class="merge-options">
          <p><strong>What would you like to do?</strong></p>

          <div class="merge-choice">
            <input type="radio" id="mergeGrants" name="grantChoice" value="merge" checked />
            <label for="mergeGrants" id="mergeLabel">
              <strong>Merge grants</strong>
              <span id="mergeDetails">- Add to existing grant</span>
            </label>
          </div>

          <div class="merge-choice">
            <input type="radio" id="separateGrants" name="grantChoice" value="separate" />
            <label for="separateGrants">
              <strong>Keep separate</strong> - Create a new separate grant
              entry
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelMergeGrants" class="btn btn-secondary">
          Cancel
        </button>
        <button id="confirmMergeGrants" class="btn btn-primary">
          Continue
        </button>
      </div>
    </div>
  </div>

  <!-- Updated Sell Grants Modal -->
  <div id="sellOptionsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Sell Grants</h3>
      </div>
      <div class="modal-body">
        <div id="sellOptionDetails" class="option-details">
          <!-- Populated dynamically -->
        </div>

        <!-- NEW: Sale Date Field (above quantity) -->
        <div class="form-group">
          <label for="saleDate">Sale Date</label>
          <input type="date" id="saleDate" required />
          <small class="form-help">Date when the sale occurred (can be in the past)</small>
        </div>

        <div class="form-group">
          <label for="quantityToSell">Quantity to Sell</label>
          <input type="number" id="quantityToSell" min="1" required />
          <small class="form-help" id="maxQuantityHelp">Maximum available: X options</small>
        </div>

        <div class="form-group">
          <label for="salePrice">Sale Price per Option</label>
          <div class="input-group">
            <span class="input-prefix">‚Ç¨</span>
            <input type="number" id="salePrice" step="0.01" min="0" required />
          </div>
        </div>

        <div class="form-group">
          <label for="saleNotes">Notes (Optional)</label>
          <textarea id="saleNotes" rows="3" placeholder="Add any notes about this sale..."></textarea>
        </div>

        <!-- SIMPLIFIED: Only show Total Sale Value and Profit/Loss -->
        <div class="sale-summary">
          <h4>üí∞ Sale Summary</h4>
          <div class="summary-line">
            <span>Total Sale Value:</span>
            <span id="totalSaleValue">‚Ç¨ 0.00</span>
          </div>
          <div class="summary-line">
            <span>Profit/Loss vs Target:</span>
            <span id="profitLossVsTarget" class="currency">‚Ç¨ 0.00</span>
          </div>
        </div>

        <div class="sell-warning">
          ‚ö†Ô∏è <strong>IMPORTANT:</strong> This only records the sale in your
          portfolio. Actual selling must be done at
          <a id="platformLink" href="https://esop.kbc.be" target="_blank">https://esop.kbc.be</a>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelSellOptions" class="btn btn-secondary">
          Cancel
        </button>
        <button id="confirmSellOptions" class="btn btn-danger">
          üí∞ Record Sale
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Tax Modal -->
  <div id="editTaxModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Tax Amount</h3>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="newTaxAmount">Tax Amount</label>
          <div class="input-group">
            <span class="input-prefix">‚Ç¨</span>
            <input type="number" id="newTaxAmount" step="0.01" min="0" />
          </div>
        </div>
        <div class="current-tax-info">
          <p>
            <strong>Auto-calculated (30%):</strong>
            <span id="autoTaxAmount">‚Ç¨ 0.00</span>
          </p>
          <p>
            <strong>Current tax:</strong>
            <span id="currentTaxAmount">‚Ç¨ 0.00</span>
          </p>
          <small class="tax-note">üí° Tax appears as code 3510 on your payslip</small>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelEditTax" class="btn btn-secondary">Cancel</button>
        <button id="confirmEditTax" class="btn btn-primary">
          Update Tax
        </button>
      </div>
    </div>
  </div>

  <!-- Option Info Modal -->
  <div id="optionInfoModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3 id="optionInfoTitle">Option Details</h3>
      </div>
      <div class="modal-body">
        <div class="option-summary">
          <!-- Populated dynamically -->
        </div>
        <div class="option-chart-container">
          <canvas id="optionInfoChart"></canvas>
        </div>
        <div class="option-stats">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="portfolioApp.closeModals()">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Delete Portfolio Entry</h3>
      </div>
      <div class="modal-body">
        <div class="delete-warning">
          <p>
            <strong>You are about to permanently delete this portfolio
              entry:</strong>
          </p>
          <div class="delete-details">
            <p>
              <strong>Grant Date:</strong>
              <span id="deleteGrantDate">-</span>
            </p>
            <p>
              <strong>Quantity:</strong>
              <span id="deleteQuantity">-</span> options
            </p>
            <p>
              <strong>Exercise Price:</strong>
              <span id="deleteExercisePrice">-</span>
            </p>
            <p>
              <strong>Current Value:</strong>
              <span id="deleteCurrentValue">-</span>
            </p>
          </div>
          <div class="delete-note">
            <p>
              <strong>Note:</strong> This action is different from selling
              options. This will completely remove the entry from your
              portfolio as if it never existed.
            </p>
            <p><strong>‚ö†Ô∏è This action cannot be undone!</strong></p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelDelete" class="btn btn-secondary">Cancel</button>
        <button id="confirmDelete" class="btn btn-danger">
          üóëÔ∏è Delete Entry
        </button>
      </div>
    </div>
  </div>
  <!-- Unified Database Management Modal - Improved Import Flow -->
  <div id="databaseManagementModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="databaseModalTitle">‚ö†Ô∏è DATABASE MANAGEMENT</h3>
      </div>
      <div class="modal-body">
        <!-- Import Database Section -->
        <div id="importDatabaseSection" class="database-section">
          <div class="database-warning">
            <div class="warning-content">
              <!-- Step 1: File Selection -->
              <div class="import-step">
                <h5>Step 1: Select Backup File</h5>
                <div class="file-selection-area">
                  <button id="selectImportFile" class="btn btn-secondary btn-full">
                    üìÅ Choose Backup File
                  </button>
                  <div id="selectedFileInfo" class="selected-file-info" style="display: none">
                    <div class="file-info-header">
                      <span class="file-icon">üìÑ</span>
                      <span id="selectedFileName" class="file-name"></span>
                    </div>
                    <div class="file-details">
                      <small id="selectedFileDetails" class="file-details-text"></small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Import Options (only shown after file is selected) -->
              <div id="importOptionsStep" class="import-step" style="display: none">
                <h5>Step 2: Import Options</h5>
                <div class="import-mode-selection">
                  <label class="radio-label">
                    <input type="radio" name="importMode" value="merge" checked />
                    <span class="radio-checkmark"></span>
                    <div class="option-content">
                      <strong>Merge with existing data</strong>
                      <small class="form-help">Adds new entries, keeps existing ones
                        (Recommended)</small>
                    </div>
                  </label>
                  <label class="radio-label">
                    <input type="radio" name="importMode" value="replace" />
                    <span class="radio-checkmark"></span>
                    <div class="option-content">
                      <strong>Replace all existing data</strong>
                      <small class="form-help danger-text">‚ö†Ô∏è This will permanently delete all current
                        data</small>
                    </div>
                  </label>
                </div>
              </div>

              <!-- Step 3: Import Summary (only shown after options are selected) -->
              <div id="importSummaryStep" class="import-step" style="display: none">
                <h5>Step 3: Import Summary</h5>
                <div class="import-summary">
                  <div class="summary-item">
                    <strong>File:</strong> <span id="summaryFileName"></span>
                  </div>
                  <div class="summary-item">
                    <strong>Mode:</strong> <span id="summaryMode"></span>
                  </div>
                  <div class="summary-warning" id="summaryWarning" style="display: none">
                    <p class="warning-text">
                      üö® This will replace all your existing portfolio data!
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Delete Database Section -->
        <div id="deleteDatabaseSection" class="database-section" style="display: none">
          <div class="delete-database-warning">
            <div class="warning-header">
              <p><strong>üö® IRREVERSIBLE ACTION üö®</strong></p>
            </div>
            <div class="warning-content">
              <p>
                <strong>You are about to permanently delete your ENTIRE portfolio
                  database.</strong>
              </p>
              <div class="warning-details">
                <p>This will permanently remove:</p>
                <ul>
                  <li>All portfolio entries and options data</li>
                  <li>All price history records</li>
                  <li>All sales transaction records</li>
                  <li>All portfolio evolution data</li>
                  <li>All application settings</li>
                </ul>
              </div>
              <div class="warning-consequences">
                <p><strong>‚ö†Ô∏è Important consequences:</strong></p>
                <ul>
                  <li>This action cannot be undone</li>
                  <li>No backup will be created automatically</li>
                  <li>You will lose all historical data</li>
                  <li>The application will restart with an empty database</li>
                </ul>
              </div>
              <div class="confirmation-section">
                <p><strong>To confirm deletion, type:</strong></p>
                <div class="confirmation-text">delete database</div>
                <div class="confirmation-input-group">
                  <label for="databaseConfirmText">Confirmation text:</label>
                  <input type="text" id="databaseConfirmText" placeholder="Type: delete database" autocomplete="off"
                    spellcheck="false" />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelDatabaseAction" class="btn btn-secondary">
          Cancel
        </button>
        <button id="confirmDatabaseAction" class="btn btn-primary" disabled>
          <span id="databaseActionText">üì• Import Database</span>
        </button>
      </div>
    </div>
  </div>

  <!-- CORRECTED Edit Sale Modal HTML -->
  <div id="editSaleModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Edit Sale Details</h3>
      </div>
      <div class="modal-body">
        <!-- Read-only Sale Information -->
        <div class="sale-overview">
          <h4>üìä Sale Information</h4>
          <p>
            <strong>Grant Date:</strong> <span id="editSaleGrantDate">-</span>
          </p>
          <p><strong>Fund:</strong> <span id="editSaleFundName">-</span></p>
          <p>
            <strong>Exercise Price:</strong>
            <span id="editSaleExercisePrice">‚Ç¨ 0.00</span>
          </p>
          <p>
            <strong>Quantity Sold:</strong>
            <span id="editSaleQuantity">0</span> options
          </p>
        </div>

        <!-- Editable Fields -->
        <div class="form-group">
          <label for="editSaleDate">Sale Date</label>
          <input type="date" id="editSaleDate" required />
          <small class="form-help">Date when the sale occurred (cannot be in the future)</small>
        </div>

        <div class="form-group">
          <label for="editSalePrice">Sale Price per Option</label>
          <div class="input-group">
            <span class="input-prefix">‚Ç¨</span>
            <input type="number" id="editSalePrice" step="0.01" min="0.01" required placeholder="16.25" />
          </div>
          <small class="form-help">Price per option when sold</small>
        </div>

        <div class="form-group">
          <label for="editSaleNotes">Notes</label>
          <textarea id="editSaleNotes" rows="3" placeholder="Add any notes about this sale..."></textarea>
          <small class="form-help">Optional notes about the sale</small>
        </div>

        <!-- Sale Summary (matches sell modal format) -->
        <div class="sale-summary">
          <h4>üí∞ Sale Summary</h4>
          <div class="summary-line">
            <span>Total Sale Value:</span>
            <span id="editTotalSaleValue">‚Ç¨ 0.00</span>
          </div>
          <div class="summary-line">
            <span>Profit/Loss vs Target:</span>
            <span id="editProfitLossVsTarget" class="currency">‚Ç¨ 0.00</span>
          </div>
        </div>

        <div class="edit-warning">
          ‚ö†Ô∏è <strong>Note:</strong> This only updates the sale record in your
          portfolio.
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelEditSale" class="btn btn-secondary">Cancel</button>
        <button id="confirmEditSale" class="btn btn-primary">
          Update Sale
        </button>
      </div>
    </div>
  </div>

  <!-- Historical Price Fetch Modal -->
  <div id="historicalPriceFetchModal" class="modal">
    <div class="modal-content modal-medium">
      <div class="modal-header">
        <h3>üìä Fetching Historical Prices</h3>
      </div>
      <div class="modal-body">
        <div class="fetch-info">
          <p>Downloading historical price data for:</p>
          <div class="option-details">
            <strong id="fetchOptionName">Option Name</strong><br>
            <span id="fetchOptionDetails">Exercise Price: ‚Ç¨0.00 | Grant Date: --</span>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar-wrapper">
            <div id="historicalFetchProgressBar" class="progress-bar" style="width: 0%"></div>
          </div>
          <div id="historicalFetchStatus" class="progress-status">Initializing...</div>
        </div>

        <div id="fetchResults" class="fetch-results" style="display: none;">
          <h4>‚úÖ Historical Data Retrieved</h4>
          <div class="result-summary">
            <div class="result-item">
              <span>Total price points:</span>
              <strong id="totalPricePoints">0</strong>
            </div>
            <div class="result-item">
              <span>Grant date price:</span>
              <strong id="grantDatePrice">‚Ç¨0.00</strong>
            </div>
            <div class="result-item">
              <span>Current price:</span>
              <strong id="currentPriceResult">‚Ç¨0.00</strong>
            </div>
            <div class="result-item">
              <span>Date range:</span>
              <strong id="dateRange">--</strong>
            </div>
          </div>
        </div>

        <div id="fetchError" class="error-message" style="display: none;">
          <span class="error-icon">‚ùå</span>
          <span id="fetchErrorMessage">Error fetching data</span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelHistoricalFetch" class="btn btn-secondary" style="display: none;">Cancel</button>
        <button id="confirmHistoricalFetch" class="btn btn-primary" disabled>
          Continue with Grant
        </button>
      </div>
    </div>
  </div>

  <!-- Bulk Historical Price Update Modal -->
  <div id="bulkHistoricalUpdateModal" class="modal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h3>üìä Updating Historical Prices</h3>
      </div>
      <div class="modal-body">
        <div class="bulk-update-info">
          <p>Downloading historical price data for all options in your portfolio...</p>
          <div class="bulk-progress-summary">
            <div class="progress-item">
              <span>Options processed:</span>
              <strong id="bulkProcessedCount">0</strong> / <strong id="bulkTotalCount">0</strong>
            </div>
            <div class="progress-item">
              <span>Current option:</span>
              <strong id="bulkCurrentOption">--</strong>
            </div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar-wrapper">
            <div id="bulkHistoricalProgressBar" class="progress-bar" style="width: 0%"></div>
          </div>
          <div id="bulkHistoricalStatus" class="progress-status">Initializing...</div>
        </div>

        <div id="bulkUpdateResults" class="bulk-results" style="display: none;">
          <h4>‚úÖ Historical Price Update Complete</h4>
          <div class="result-summary">
            <div class="result-item">
              <span>Options updated:</span>
              <strong id="bulkSuccessCount">0</strong>
            </div>
            <div class="result-item">
              <span>Errors:</span>
              <strong id="bulkErrorCount">0</strong>
            </div>
            <div class="result-item">
              <span>Total price points:</span>
              <strong id="bulkTotalPricePoints">0</strong>
            </div>
          </div>
          <p class="recalculation-note">
            ‚úÖ Portfolio evolution has been recalculated with historical prices
          </p>
        </div>

        <div id="bulkUpdateError" class="error-message" style="display: none;">
          <span class="error-icon">‚ùå</span>
          <span id="bulkUpdateErrorMessage">Error updating historical prices</span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelBulkUpdate" class="btn btn-secondary" style="display: none;">Cancel</button>
        <button id="closeBulkUpdate" class="btn btn-primary" style="display: none;">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- FOOTER - CENTERED STRUCTURE -->
  <!-- FOOTER - POSITIONED AS FLEX ITEM -->
  <footer class="app-footer">
    <div class="footer-content">
      <div class="footer-text">
        <span class="version-info" id="appVersion">Loading...</span>
        <span class="footer-divider">‚Ä¢</span>
        <span class="footer-note" id="appStatus">Loading...</span>
        <span class="footer-divider">‚Ä¢</span>
        <span class="build-info" id="buildDate">Loading...</span>
      </div>
    </div>
  </footer>

  <!-- Scripts at the very bottom -->
  <script src="libs/chart.min.js"></script>
  <script src="libs/chartjs-plugin-annotation.min.js"></script>
  <script>
    if (typeof Chart !== "undefined") {
      Chart.register({
        id: "annotation",
      });
      console.log("‚úÖ Chart.js loaded with annotation support");
    } else {
      console.error("‚ùå Chart.js not loaded");
    }
  </script>

  <!-- LOAD ALL UTILITIES IN CORRECT ORDER -->
  <script src="utils/formatters.js"></script>
  <script src="utils/config.js"></script>
  <script src="utils/portfolio-calculations.js"></script>
  <script src="utils/dom-helpers.js"></script>
  <script src="utils/event-handlers.js"></script>
  <script src="utils/ipc-communication.js"></script>
  <script src="utils/chart-visualization.js"></script>
  <!-- UI State Management MUST load before renderer.js -->
  <script src="utils/modal-manager.js"></script>
  <script src="utils/notification-manager.js"></script>
  <script src="utils/tab-manager.js"></script>
  <script src="utils/table-manager.js"></script>
  <script src="utils/stats-manager.js"></script>
  <script src="utils/action-button-manager.js"></script>
  <script src="utils/ui-state-management.js"></script>
  <script src="utils/data-loader.js"></script>
  <script src="utils/app-helpers.js"></script>
  <script src="utils/historical-price-manager.js"></script>
  <script src="utils/version-checker-toast.js"></script>
  <script src="utils/undo-redo-manager.js"></script>
  <script src="utils/ipc-undo-redo-extension.js"></script>
  <!-- LOAD MAIN APP LAST -->
  <script src="renderer.js"></script>
</body>

</html>